From 2878316a45e4e7e9a4c6fc7b15defcc2c8464540 Mon Sep 17 00:00:00 2001
From: Andiry Xu <jix024@cs.ucsd.edu>
Date: Mon, 20 Feb 2017 13:11:15 -0800
Subject: [PATCH 7/8] Do not check vma page prot in page fault handler

Signed-off-by: Andiry Xu <jix024@cs.ucsd.edu>
---
 arch/x86/mm/fault.c | 10 ++++------
 1 file changed, 4 insertions(+), 6 deletions(-)

diff --git a/arch/x86/mm/fault.c b/arch/x86/mm/fault.c
index 5778324..f9b4bac 100644
--- a/arch/x86/mm/fault.c
+++ b/arch/x86/mm/fault.c
@@ -1385,13 +1385,11 @@ __do_page_fault(struct pt_regs *regs, unsigned long error_code,
 
 	if (error_code & PF_WRITE) {
 		/* write, present and write, not present: */
-		if (unlikely(!(vma->vm_flags & VM_WRITE))) {
-			if (vma->original_write && vma->vm_ops &&
+		if (vma->original_write && vma->vm_ops &&
 					vma->vm_ops->dax_cow) {
-				up_read(&mm->mmap_sem);
-				vma->vm_ops->dax_cow(vma);
-				down_read(&mm->mmap_sem);
-			}
+			up_read(&mm->mmap_sem);
+			vma->vm_ops->dax_cow(vma);
+			down_read(&mm->mmap_sem);
 		}
 	}
 
-- 
2.7.4

